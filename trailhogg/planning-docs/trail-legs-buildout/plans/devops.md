# DevOps Assessment: Trail Legs Build-Out

**Project:** Trail Legs Game
**Date:** 2026-01-07
**Consultant:** DevOps Consultant
**Document Type:** Platform Deployment Plan

---

## Executive Summary

Trail Legs requires a practical cross-platform deployment strategy for web, PWA, iOS, and Android. The current codebase has a clean monorepo structure with minimal build tooling, which provides a good foundation but needs significant enhancement for production deployment.

The key DevOps challenges are:
1. **No Capacitor setup** - Native builds are not yet configured
2. **No PWA configuration** - Service worker and manifest are absent
3. **No CI/CD pipeline** - All builds are manual
4. **No platform-specific scripts** - Only basic dev/build commands exist

This assessment provides a phased approach prioritizing web deployment first (fastest path to users), then PWA, then native apps (App Store/Play Store).

---

## Current State Analysis

### Existing Build Infrastructure

| Aspect | Current State | Assessment |
|--------|---------------|------------|
| Package Manager | npm | Adequate |
| Build Tool | Vite 5.0.0 | Needs upgrade to 6.x+ |
| TypeScript | 5.3.3 | Adequate, minor upgrade recommended |
| Monorepo Structure | Workspace with client/server/shared | Clean structure |
| Development Server | Vite dev server + ts-node-dev | Works locally |
| Production Build | `vite build` | Outputs to `dist/` |

### Root Package Scripts (Current)

```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:server\" \"npm run dev:client\"",
    "dev:server": "cd server && npm run dev",
    "dev:client": "cd client && npm run dev",
    "build": "npm run build:server && npm run build:client",
    "build:server": "cd server && npm run build",
    "build:client": "cd client && npm run build",
    "start": "cd server && npm start"
  }
}
```

### Client Package Scripts (Current)

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  }
}
```

### Vite Configuration (Current)

```typescript
// Minimal configuration with WebSocket proxy for Colyseus
export default defineConfig({
  server: {
    port: 3000,
    proxy: {
      '/colyseus': {
        target: 'ws://localhost:2567',
        ws: true
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
});
```

---

## 1. Build Pipeline

### Required Scripts

The client package.json needs these additional scripts for multi-platform builds:

| Script | Purpose | Command Pattern |
|--------|---------|-----------------|
| `build:web` | Production web bundle | `vite build` |
| `build:pwa` | PWA-enabled build | `vite build` (with PWA plugin) |
| `build:ios` | Sync to iOS project | `vite build && cap sync ios` |
| `build:android` | Sync to Android project | `vite build && cap sync android` |
| `open:ios` | Open Xcode | `cap open ios` |
| `open:android` | Open Android Studio | `cap open android` |

### Recommended Client Package Scripts

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "build:web": "tsc && vite build",
    "build:ios": "npm run build && cap sync ios",
    "build:android": "npm run build && cap sync android",
    "open:ios": "cap open ios",
    "open:android": "cap open android",
    "preview": "vite preview",
    "typecheck": "tsc --noEmit"
  }
}
```

### Build Output Structure

```
client/
  dist/              # Web build output
  ios/               # Xcode project (generated by Capacitor)
  android/           # Android Studio project (generated by Capacitor)
```

---

## 2. Capacitor Setup

### Installation Steps

```bash
# From client directory
npm install @capacitor/core @capacitor/cli
npx cap init "Trail Legs" "com.hoggcountry.traillegs" --web-dir dist
npm install @capacitor/ios @capacitor/android
npm install @capacitor/splash-screen @capacitor/status-bar
npm install @capacitor/haptics  # For touch feedback
```

### Configuration File Required

**File: `client/capacitor.config.ts`**

```typescript
import type { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.hoggcountry.traillegs',
  appName: 'Trail Legs',
  webDir: 'dist',
  server: {
    androidScheme: 'https'
  },
  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: '#1a1a1a',
      showSpinner: false
    },
    StatusBar: {
      style: 'dark'
    }
  }
};

export default config;
```

### Platform Initialization

After first build:

```bash
# Generate platform projects
npx cap add ios
npx cap add android

# After each build, sync changes
npx cap sync
```

### iOS-Specific Requirements

| Requirement | Details |
|-------------|---------|
| macOS | Required for iOS builds |
| Xcode | Version 14+ recommended |
| Apple Developer Account | $99/year for App Store |
| Signing Certificates | Development + Distribution |
| Provisioning Profiles | App ID: com.hoggcountry.traillegs |

### Android-Specific Requirements

| Requirement | Details |
|-------------|---------|
| Android Studio | Latest stable version |
| SDK | API 29+ (Android 10+) |
| Google Play Console | $25 one-time registration |
| Keystore | Release signing key |

---

## 3. PWA Configuration

### Required Packages

```bash
npm install -D vite-plugin-pwa workbox-window
```

### Vite PWA Plugin Configuration

**Enhanced `vite.config.ts`:**

```typescript
import { defineConfig } from 'vite';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'robots.txt', 'apple-touch-icon.png'],
      manifest: {
        name: 'Trail Legs',
        short_name: 'Trail Legs',
        description: 'An Appalachian Trail thru-hiking simulation',
        theme_color: '#1a1a1a',
        background_color: '#1a1a1a',
        display: 'standalone',
        orientation: 'any',
        icons: [
          {
            src: 'icons/icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'icons/icon-512.png',
            sizes: '512x512',
            type: 'image/png'
          },
          {
            src: 'icons/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'maskable'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2,json}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365
              }
            }
          }
        ]
      }
    })
  ],
  server: {
    port: 3000,
    proxy: {
      '/colyseus': {
        target: 'ws://localhost:2567',
        ws: true
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
});
```

### PWA Assets Required

| Asset | Size | Purpose |
|-------|------|---------|
| `public/icons/icon-192.png` | 192x192 | Android home screen |
| `public/icons/icon-512.png` | 512x512 | Splash screen |
| `public/apple-touch-icon.png` | 180x180 | iOS home screen |
| `public/favicon.ico` | Multi-size | Browser tab |

### Service Worker Caching Strategy

| Resource Type | Strategy | Rationale |
|---------------|----------|-----------|
| HTML | Network First | Always show fresh content |
| JS/CSS | Cache First | Static after build |
| Images/Sprites | Cache First | Game assets don't change |
| Audio | Cache First | Sound files are static |
| API Calls | Network Only | Dynamic data (if any) |

---

## 4. Deployment Strategy

### Web Deployment Options

| Platform | Pros | Cons | Recommendation |
|----------|------|------|----------------|
| **Vercel** | Free tier, automatic deploys, great for static | Limited backend options | Best for static client |
| **Netlify** | Free tier, form handling, edge functions | Similar to Vercel | Alternative to Vercel |
| **Cloudflare Pages** | Unlimited bandwidth, fast CDN | Newer platform | Great for performance |
| **GitHub Pages** | Free, integrated with repo | No server-side | Not suitable (need server) |

### Recommended Architecture

```
                    +------------------+
                    |   Cloudflare CDN |
                    +--------+---------+
                             |
              +--------------+---------------+
              |                              |
    +---------v---------+         +----------v---------+
    |  Static Hosting   |         |  Server Hosting    |
    |  (Vercel/Netlify) |         |  (Railway/Render)  |
    |                   |         |                    |
    |  - Client bundle  |         |  - Colyseus server |
    |  - PWA assets     |         |  - WebSocket       |
    |  - Game assets    |         |  - Optional: API   |
    +-------------------+         +--------------------+
```

### Server Deployment Options

| Platform | Pros | Cons | Cost |
|----------|------|------|------|
| **Railway** | Simple, WebSocket support | Usage-based | ~$5-20/mo |
| **Render** | Free tier, easy deploy | Cold starts on free | Free-$15/mo |
| **Fly.io** | Edge deployment, WebSocket | More complex setup | ~$5-15/mo |
| **DigitalOcean App Platform** | Predictable pricing | More expensive | $12+/mo |

### Deployment Files Needed

**`vercel.json` (for static client):**

```json
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" }
      ]
    }
  ]
}
```

**`Dockerfile` (for server):**

```dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
COPY shared ./shared
COPY server ./server
RUN cd shared && npm ci && npm run build
RUN cd server && npm ci && npm run build

FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/shared/dist ./shared/dist
COPY --from=builder /app/shared/package*.json ./shared/
COPY --from=builder /app/server/dist ./server/dist
COPY --from=builder /app/server/package*.json ./server/
RUN cd shared && npm ci --production
RUN cd server && npm ci --production
EXPOSE 2567
CMD ["node", "server/dist/index.js"]
```

---

## 5. App Store Preparation

### iOS App Store Requirements

| Requirement | Status | Action Required |
|-------------|--------|-----------------|
| Apple Developer Account | Unknown | Create/verify $99/year account |
| App ID | Not created | Register com.hoggcountry.traillegs |
| App Icon | Not created | 1024x1024 PNG, no alpha |
| Screenshots | Not created | 6.5" and 5.5" device sizes minimum |
| App Description | Draft available | Refine for App Store |
| Privacy Policy | Not created | Required for all apps |
| Age Rating | Not set | 4+ (no objectionable content) |

### App Store Icon Set

| Size | Filename | Purpose |
|------|----------|---------|
| 1024x1024 | AppIcon.png | App Store listing |
| 180x180 | Icon-60@3x.png | iPhone |
| 120x120 | Icon-60@2x.png | iPhone |
| 167x167 | Icon-83.5@2x.png | iPad Pro |
| 152x152 | Icon-76@2x.png | iPad |

### Google Play Store Requirements

| Requirement | Status | Action Required |
|-------------|--------|-----------------|
| Google Play Console | Unknown | Create/verify $25 account |
| Package Name | Defined | com.hoggcountry.traillegs |
| App Icon | Not created | 512x512 PNG |
| Feature Graphic | Not created | 1024x500 PNG |
| Screenshots | Not created | Phone and tablet sizes |
| Store Listing | Draft available | Title, description, category |
| Privacy Policy | Not created | Required URL |
| Content Rating | Not set | IARC questionnaire |

### Signing Configuration

**iOS:** Managed through Xcode signing capabilities or Fastlane Match

**Android Keystore Generation:**

```bash
keytool -genkey -v -keystore trail-legs-release.keystore \
  -alias trail-legs -keyalg RSA -keysize 2048 -validity 10000
```

Store keystore securely. Never commit to git.

---

## 6. Development Workflow

### Local Development

```bash
# Terminal 1: Start dev server
npm run dev
# This runs both client (port 3000) and server (port 2567)

# Browser: http://localhost:3000
```

### Mobile Testing During Development

**iOS Simulator:**

```bash
cd client
npm run build
npx cap sync ios
npx cap open ios
# Run on simulator from Xcode
```

**Android Emulator:**

```bash
cd client
npm run build
npx cap sync android
npx cap open android
# Run on emulator from Android Studio
```

**Physical Device Testing:**

```bash
# iOS - requires Mac with Xcode
npx cap run ios --target=device

# Android - enable USB debugging
npx cap run android --target=device
```

### Hot Reload for Mobile

Capacitor supports live reload during development:

**capacitor.config.ts (dev mode):**

```typescript
const config: CapacitorConfig = {
  // ... other config
  server: {
    url: 'http://YOUR_LOCAL_IP:3000',  // Replace with machine IP
    cleartext: true
  }
};
```

Remove server.url for production builds.

### Environment Variables

| Variable | Dev Value | Prod Value | Purpose |
|----------|-----------|------------|---------|
| `VITE_WS_URL` | `ws://localhost:2567` | `wss://server.example.com` | Colyseus server |
| `VITE_ENV` | `development` | `production` | Environment flag |

---

## 7. CI/CD Pipeline (Optional for MVP)

The PRD notes CI/CD is optional. Here is a lightweight GitHub Actions setup if desired.

### Basic Build Verification

**`.github/workflows/build.yml`:**

```yaml
name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd shared && npm ci
          cd ../server && npm ci
          cd ../client && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Build server
        run: cd server && npm run build

      - name: Build client
        run: cd client && npm run build

      - name: Upload client artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-dist
          path: client/dist
```

### Auto-Deploy to Vercel

If using Vercel, connect the repository directly for automatic deploys. No GitHub Action needed.

### Future: App Store Deployment

For automated iOS/Android builds, consider:
- **Fastlane** for app signing and store uploads
- **GitHub Actions with macOS runner** for iOS builds
- **Expo EAS Build** if migrating to Expo (not recommended for Phaser)

---

## 8. Recommendations

### Priority 1: Web Deployment (Week 1)

| Task | Effort | Notes |
|------|--------|-------|
| Upgrade Vite to 6.x | Low | Minor breaking changes |
| Add PWA plugin and manifest | Medium | Copy configuration above |
| Create PWA icons | Low | Can use placeholder initially |
| Deploy to Vercel/Netlify | Low | Connect repo, deploy |
| Deploy server to Railway/Render | Medium | Dockerfile provided |

### Priority 2: Capacitor Setup (Week 2)

| Task | Effort | Notes |
|------|--------|-------|
| Install Capacitor | Low | npm install |
| Configure capacitor.config.ts | Low | Copy configuration above |
| Generate iOS project | Low | `cap add ios` |
| Generate Android project | Low | `cap add android` |
| Test on simulators | Medium | Verify touch input works |

### Priority 3: App Store Prep (Week 3-4)

| Task | Effort | Notes |
|------|--------|-------|
| Create app icons | Medium | All required sizes |
| Write privacy policy | Low | Standard template |
| Create screenshots | Medium | Requires playable build |
| Register on App Store Connect | Low | Requires Apple account |
| Register on Google Play Console | Low | Requires Google account |

### Priority 4: CI/CD (Optional)

| Task | Effort | Notes |
|------|--------|-------|
| Add build verification workflow | Low | Use template above |
| Configure auto-deploy | Low | Vercel/Netlify integration |
| Add mobile build workflow | High | Requires macOS runner |

---

## Open Questions

1. **Hosting Budget:** What is the monthly budget for server hosting?
2. **Apple Developer Account:** Does an Apple Developer account exist?
3. **Google Play Console:** Does a Google Play Console account exist?
4. **Domain:** Will the game have a dedicated domain (e.g., traillegs.game)?
5. **Analytics:** Is any analytics/telemetry needed for MVP?
6. **Colyseus Scaling:** Is multiplayer required at launch, or can it be offline-only?

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| iOS build issues on non-macOS | High | Medium | Defer iOS to developer with Mac |
| App Store rejection | Medium | High | Follow guidelines strictly |
| WebSocket hosting complexity | Medium | Medium | Start with Railway (simpler) |
| PWA caching bugs | Low | Medium | Thorough testing |
| Asset loading failures | Low | High | Pre-cache all game assets |

---

## Summary

The Trail Legs project has a clean foundation for multi-platform deployment. The recommended approach is:

1. **Start with web** - Deploy static client to Vercel, server to Railway
2. **Add PWA** - Enable offline installation with vite-plugin-pwa
3. **Add Capacitor** - Generate iOS/Android projects
4. **Submit to stores** - After thorough mobile testing

This phased approach gets the game into players' hands quickly (web) while building toward native apps. The offline-first architecture described in the PRD aligns well with PWA and Capacitor capabilities.

---

*End of DevOps Assessment*
