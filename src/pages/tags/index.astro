---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

// Build tag index from trips and posts collections at build time
const tripEntries = await getCollection('trips');
const postEntries = await getCollection('posts');

type TagBuckets = { trips: string[]; blog: string[] };
const byTag = new Map<string, TagBuckets>();

for (const t of tripEntries) {
  for (const tag of t.data.tags || []) {
    const bucket = byTag.get(tag) || { trips: [], blog: [] };
    bucket.trips.push(t.id);
    byTag.set(tag, bucket);
  }
}

for (const p of postEntries) {
  for (const tag of p.data.tags || []) {
    const bucket = byTag.get(tag) || { trips: [], blog: [] };
    bucket.blog.push(p.id);
    byTag.set(tag, bucket);
  }
}

const tags = Array.from(byTag.entries()).sort((a, b) => {
  const aCount = a[1].trips.length + a[1].blog.length;
  const bCount = b[1].trips.length + b[1].blog.length;
  return bCount - aCount;
});
---
<html lang="en">
  <head>
    <BaseHead title="Tags • Hogg Country" description="Browse by tag" />
  </head>
  <body>
    <Header />
    <main style="max-width: 860px; margin: 0 auto; padding: 1rem;">
      <h1>Tags</h1>
      <ul style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: .75rem; list-style:none; padding:0;">
        {tags.map(([tag, data]) => (
          <li><a href={`/tags/${encodeURIComponent(tag)}/`} style="display:block; border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .75rem; text-decoration:none; color:inherit;">
            <strong>{tag}</strong>
            <div style="color:#6b7280; font-size:.85rem;">{data.trips.length} trips • {data.blog.length} posts</div>
          </a></li>
        ))}
      </ul>
    </main>
    <Footer />
  </body>
</html>
